<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accept Invitation - COO Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .container {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 480px;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #333;
      font-size: 28px;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 15px;
    }
    
    .invite-info {
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 25px;
      border-radius: 4px;
    }
    
    .invite-info p {
      margin: 5px 0;
      color: #555;
      font-size: 14px;
    }
    
    .invite-info strong {
      color: #333;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    
    input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    input:disabled {
      background: #f5f5f5;
      color: #999;
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #5568d3;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .error {
      background: #fce4ec;
      color: #c62828;
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #e1e8ed;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .password-requirements {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Accept Invitation</h1>
    <div class="subtitle">COO Dashboard v12</div>
    
    <div id="content">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Loading invitation...</p>
      </div>
    </div>
  </div>
  
  <script>
    // ⚠️ IMPORTANT: Replace with your Apps Script web app URL
    const API_URL = 'https://script.google.com/macros/s/AKfycby5GzBOvElKpBryhEvq4mWVmL3vvFCrM6RJmW6B1i0F1u_UiImcxNmryxq_mnDvTN9C/exec';
    
    const urlParams = new URLSearchParams(window.location.search);
    const inviteToken = urlParams.get('token');
    
    if (!inviteToken) {
      showError('Invalid invitation link');
    } else {
      loadInviteDetails();
    }
    
    async function loadInviteDetails() {
      try {
        const url = `${API_URL}?action=invite-details&token=${encodeURIComponent(inviteToken)}`;
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
          showInviteForm(result.invite);
        } else {
          showError(result.error);
        }
      } catch (error) {
        console.error('Load invite error:', error);
        showError('Failed to load invitation. Please check your connection.');
      }
    }
    
    function showInviteForm(invite) {
      const content = document.getElementById('content');
      
      content.innerHTML = `
        <div class="invite-info">
          <p><strong>Email:</strong> ${invite.email}</p>
          <p><strong>Role:</strong> ${invite.role}</p>
          <p><strong>Department:</strong> ${invite.department}</p>
          <p><strong>Invited by:</strong> ${invite.invitedBy}</p>
        </div>
        
        <form id="acceptForm">
          <div class="form-group">
            <label for="name">Your Name</label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              required 
              placeholder="Enter your full name"
            >
          </div>
          
          <div class="form-group">
            <label for="password">Choose Password</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              required 
              placeholder="Enter a strong password"
              minlength="6"
            >
            <div class="password-requirements">At least 6 characters</div>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input 
              type="password" 
              id="confirmPassword" 
              name="confirmPassword" 
              required 
              placeholder="Re-enter your password"
            >
          </div>
          
          <button type="submit" id="acceptBtn">Accept Invitation</button>
          
          <div id="message"></div>
        </form>
      `;
      
      document.getElementById('acceptForm').addEventListener('submit', handleAcceptInvite);
    }
    
    async function handleAcceptInvite(e) {
      e.preventDefault();
      
      const btn = document.getElementById('acceptBtn');
      const messageDiv = document.getElementById('message');
      const name = document.getElementById('name').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Validate passwords match
      if (password !== confirmPassword) {
        messageDiv.innerHTML = '<div class="error">Passwords do not match</div>';
        return;
      }
      
      // Validate password length
      if (password.length < 6) {
        messageDiv.innerHTML = '<div class="error">Password must be at least 6 characters</div>';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Creating your account...';
      messageDiv.innerHTML = '';
      
      try {
        const url = `${API_URL}?action=accept-invite&token=${encodeURIComponent(inviteToken)}&password=${encodeURIComponent(password)}&name=${encodeURIComponent(name)}`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
          messageDiv.innerHTML = '<div class="success">✓ Account created successfully! Redirecting to login...</div>';
          
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
          
        } else {
          messageDiv.innerHTML = `<div class="error">${result.error}</div>`;
          btn.disabled = false;
          btn.textContent = 'Accept Invitation';
        }
        
      } catch (error) {
        console.error('Accept invite error:', error);
        messageDiv.innerHTML = '<div class="error">Failed to create account. Please try again.</div>';
        btn.disabled = false;
        btn.textContent = 'Accept Invitation';
      }
    }
    
    function showError(message) {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="error">${message}</div>
        <p style="text-align: center; margin-top: 20px; color: #666;">
          <a href="login.html" style="color: #667eea; text-decoration: none;">← Back to Login</a>
        </p>
      `;
    }
  </script>
</body>
</html>
